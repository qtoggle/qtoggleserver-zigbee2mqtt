name: Main

on: push

jobs:

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Source code checkout
        uses: actions/checkout@v4
      - name: Python setup
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install uv
        uses: astral-sh/setup-uv@v6
      - name: Extract version from tag
        id: tagName
        uses: olegtarasov/get-tag@v2.1.4
        with:
          tagRegex: "version-(.*)"
      - name: Update source version
        run: sed -i "s/unknown-version/${{ steps.tagName.outputs.tag }}/" qtoggleserver/*/__init__.py pyproject.toml
      - name: Ruff check
        run: uv run ruff check qtoggleserver

  build:
    name: Build Package
    if: startsWith(github.ref, 'refs/tags/version-')
    needs:
      - lint
    runs-on: ubuntu-latest
    steps:
      - name: Source code checkout
        uses: actions/checkout@v4
      - name: Python Setup
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install uv
        uses: astral-sh/setup-uv@v6
      - name: Extract version from tag
        id: tagName
        uses: olegtarasov/get-tag@v2.1.4
        with:
          tagRegex: "version-(.*)"
      - name: Update source version
        run: sed -i "s/unknown-version/${{ steps.tagName.outputs.tag }}/" qtoggleserver/*/__init__.py pyproject.toml
      - name: Build Python package
        run: uv build
      - name: Store dist package
        uses: actions/upload-artifact@v4
        with:
          name: python-package-dist
          path: dist/

  publish:
    name: Publish Package
    if: startsWith(github.ref, 'refs/tags/version-')
    needs:
      - build
    runs-on: ubuntu-latest
    steps:
      - name: Fetch dist package
        uses: actions/download-artifact@v4
        with:
          name: python-package-dist
          path: dist/
      - name: Publish package
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          user: __token__
          password: ${{ secrets.PYPI_TOKEN }}
