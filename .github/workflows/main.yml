name: Main

on: push

jobs:

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Source code checkout
        uses: actions/checkout@v4
      - name: Update source version
        run: |
          [[ "${GITHUB_REF_NAME}" =~ ^version-.*$ ]] && VERSION=${GITHUB_REF_NAME:8} || VERSION=0.0.0;
          sed -i "s/unknown-version/${VERSION}/" qtoggleserver/*/__init__.py pyproject.toml;
          echo "VERSION = ${VERSION}"
      - name: Python setup
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install uv
        uses: astral-sh/setup-uv@v6
      - name: Ruff check
        run: uv run ruff check qtoggleserver

  build:
    name: Build Package
    if: startsWith(github.ref, 'refs/tags/version-')
    needs:
      - lint
    runs-on: ubuntu-latest
    steps:
      - name: Source code checkout
        uses: actions/checkout@v4
      - name: Python Setup
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install uv
        uses: astral-sh/setup-uv@v6
      - name: Build Python package
        run: uv build
      - name: Store dist package
        uses: actions/upload-artifact@v4
        with:
          name: python-package-dist
          path: dist/

  publish:
    name: Publish Package
    if: startsWith(github.ref, 'refs/tags/version-')
    needs:
      - build
    runs-on: ubuntu-latest
    steps:
      - name: Fetch dist package
        uses: actions/download-artifact@v4
        with:
          name: python-package-dist
          path: dist/
      - name: Publish package
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          user: __token__
          password: ${{ secrets.PYPI_TOKEN }}
